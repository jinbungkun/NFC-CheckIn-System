<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë„ì¥ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    :root { --bg: #0f172a; --card: #1e293b; --primary: #3b82f6; --success: #10b981; --accent: #f59e0b; --text: #f8fafc; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
    .page { display: none; } .page.active { display: block; }
    .glass-card { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 15px; }
    input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #334155; background: #000; color: #fff; box-sizing: border-box; }
    .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn-blue { background: var(--primary); color: white; width: 100%; }
    .admin-only { display: none; }
    /* í¬ì¸íŠ¸ ë²„íŠ¼ ê·¸ë£¹ */
    .pt-grid { display: grid; grid-template-columns: 1-1-1-1; gap: 10px; margin: 10px 0; }
    .pt-btn { background: #334155; color: white; padding: 10px; border-radius: 8px; border: 1px solid var(--primary); cursor: pointer; }
    .nav { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; }
    .nav button { background: var(--card); color: #94a3b8; border: none; padding: 10px 15px; border-radius: 8px; white-space: nowrap; }
    .nav button.active { background: var(--primary); color: white; }
  </style>
</head>
<body>

  <div class="header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
    <span id="admin-tag" style="font-size:0.8rem; color:var(--accent);"></span>
    <button onclick="toggleAdmin()" id="lock-btn">ğŸ”’</button>
  </div>

  <div class="nav">
    <button onclick="showPage('checkin')" id="nav-checkin" class="active">ì¶œì„/ì¡°íšŒ</button>
    <button onclick="showPage('manage')" id="nav-manage" class="admin-only">í¬ì¸íŠ¸/êµì²´</button>
    <button onclick="showPage('add')" id="nav-add" class="admin-only">ì‹ ê·œë“±ë¡</button>
    <button onclick="showPage('settings')" id="nav-settings" class="admin-only">ì„¤ì •</button>
  </div>

  <div id="page-checkin" class="page active">
    <div class="glass-card">
      <h2 style="text-align:center;">ğŸ“¡ NFC íƒœê·¸</h2>
      <div id="scan-result" style="text-align:center; padding:15px; font-size:1.1rem; color:var(--success);">í•™ìƒ ì •ë³´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
      <input type="tel" id="main-id" placeholder="ID ì§ì ‘ ì…ë ¥ (ì—”í„°)">
    </div>
  </div>

  <div id="page-manage" class="page">
    <div class="glass-card">
      <h3>ğŸ’° í¬ì¸íŠ¸ ì§€ê¸‰</h3>
      <p id="target-info">ëŒ€ìƒì„ ë¨¼ì € íƒœê·¸í•˜ì„¸ìš”.</p>
      <div class="pt-grid">
        <button class="pt-btn" onclick="addPt(100)">100</button>
        <button class="pt-btn" onclick="addPt(300)">300</button>
        <button class="pt-btn" onclick="addPt(500)">500</button>
        <button class="pt-btn" onclick="addPt(1000)">1000</button>
      </div>
      <input type="number" id="custom-pt" placeholder="ê¸°íƒ€ í¬ì¸íŠ¸ ì§ì ‘ ì…ë ¥">
      <button class="btn btn-blue" onclick="addPt(document.getElementById('custom-pt').value)">ì§€ê¸‰í•˜ê¸°</button>
    </div>

    <div class="glass-card" style="border: 1px solid var(--danger);">
      <h3>ğŸ´ ì¹´ë“œ ë¶„ì‹¤/êµì²´</h3>
      <input type="text" id="replace-name" placeholder="ì´ë¦„ ê²€ìƒ‰">
      <input type="text" id="replace-new-id" placeholder="ìƒˆë¡œìš´ NFC ì¹´ë“œ íƒœê·¸" readonly>
      <button class="btn btn-blue" style="background:var(--danger);" onclick="replaceCard()">ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸</button>
    </div>
  </div>

  <div id="page-add" class="page">
    <div class="glass-card">
      <h3>ğŸ‘¤ ì‹ ê·œ ë“±ë¡</h3>
      <input id="add-id" placeholder="ID (íƒœê·¸í•˜ì„¸ìš”)" readonly>
      <input id="add-name" placeholder="í•™ìƒ ì´ë¦„">
      <input id="add-tel" placeholder="ì „í™”ë²ˆí˜¸">
      <button class="btn btn-blue" onclick="register()">ë“±ë¡ ì™„ë£Œ</button>
    </div>
  </div>

  <div id="page-settings" class="page">
    <div class="glass-card">
      <input id="cfg-url" placeholder="GAS URL">
      <input id="cfg-pw" placeholder="ì´ˆê¸° ë¹„ë²ˆ">
      <button class="btn btn-blue" onclick="setup()">ì €ì¥</button>
    </div>
  </div>

  <input type="text" id="nfc-bridge" style="position:fixed; left:-9999px;">

  <script>
    let isAdmin = localStorage.getItem('isAdmin') === 'true';
    let currentStudentId = null;

    window.onload = () => {
      updateAdminUI();
      if(!localStorage.getItem('GAS_URL')) showPage('settings');
      focusBridge();
    };

    function focusBridge() { document.getElementById('nfc-bridge').focus(); }
    document.body.onclick = () => focusBridge();

    // [í•µì‹¬] ë¦¬ë”ê¸° ì…ë ¥ ì²˜ë¦¬
    document.getElementById('nfc-bridge').onkeydown = async (e) => {
      if(e.key === 'Enter') {
        const id = e.target.value;
        const page = document.querySelector('.page.active').id;

        if(page === 'page-checkin') {
          const res = await callApi({action: 'getStudent', id: id});
          if(res.success) {
            currentStudentId = id;
            document.getElementById('scan-result').innerHTML = `<b>${res.data.ì´ë¦„}</b> [${res.data.í¬ì¸íŠ¸} PT]<br>ì¶œì„ í™•ì¸ë¨!`;
            if(isAdmin) document.getElementById('target-info').innerText = `ì„ íƒë¨: ${res.data.ì´ë¦„}`;
            // ì¶œì„ ë¡œì§ ì‹¤í–‰
            callApi({action: 'checkin', id: id});
          } else {
            document.getElementById('scan-result').innerText = "ë¯¸ë“±ë¡ ì¹´ë“œì…ë‹ˆë‹¤.";
          }
        } else if(page === 'page-manage') {
          document.getElementById('replace-new-id').value = id; // ì¹´ë“œ êµì²´ìš© ID í•„ë“œ
        } else if(page === 'page-add') {
          document.getElementById('add-id').value = id;
        }
        e.target.value = "";
      }
    };

    async function addPt(val) {
      if(!currentStudentId) return alert("ëŒ€ìƒì„ ë¨¼ì € íƒœê·¸í•˜ì„¸ìš”.");
      const res = await callApi({action: 'addPoints', id: currentStudentId, amount: val});
      if(res.success) {
        alert("ì§€ê¸‰ ì™„ë£Œ! í˜„ì¬: " + res.newTotal);
        document.getElementById('target-info').innerText = `ì„ íƒë¨: ${currentStudentId} (í˜„ì¬ ${res.newTotal} PT)`;
      }
    }

    async function replaceCard() {
      const name = document.getElementById('replace-name').value;
      const newId = document.getElementById('replace-new-id').value;
      if(!name || !newId) return alert("ì´ë¦„ ê²€ìƒ‰ê³¼ ìƒˆ ì¹´ë“œ íƒœê·¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
      const res = await callApi({action: 'replaceCard', name: name, newId: newId});
      alert(res.message);
    }

    async function toggleAdmin() {
      if(!isAdmin) {
        const pw = prompt("ê´€ë¦¬ì ë¹„ë²ˆ");
        const res = await callApi({action: 'verifyPw', pw: pw});
        if(res && res.success) {
          isAdmin = true;
          localStorage.setItem('isAdmin', 'true'); // ê´€ë¦¬ì ìƒíƒœ ìœ ì§€
          updateAdminUI();
        }
      } else {
        isAdmin = false;
        localStorage.setItem('isAdmin', 'false');
        updateAdminUI();
      }
    }

    function updateAdminUI() {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
      document.getElementById('admin-tag').innerText = isAdmin ? "â— ê´€ë¦¬ì ëª¨ë“œ ìœ ì§€ë¨" : "";
      document.getElementById('lock-btn').innerText = isAdmin ? "ğŸ”“" : "ğŸ”’";
    }

    async function showPage(p) {
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
      document.getElementById('page-'+p).classList.add('active');
      document.querySelectorAll('.nav button').forEach(el => el.classList.remove('active'));
      document.getElementById('nav-'+p).classList.add('active');
      focusBridge();
    }

    async function callApi(d) {
      const url = localStorage.getItem('GAS_URL');
      try {
        const r = await fetch(url, {method: 'POST', body: JSON.stringify(d)});
        return await r.json();
      } catch(e) { return {success:false, message: "í†µì‹ ì˜¤ë¥˜"}; }
    }

    async function setup() {
      const url = document.getElementById('cfg-url').value;
      const pw = document.getElementById('cfg-pw').value;
      localStorage.setItem('GAS_URL', url);
      const res = await callApi({action: 'initSheet', pw: pw});
      alert(res.message);
      location.reload();
    }
    
    async function register() {
      const data = {action: 'add', ID: document.getElementById('add-id').value, ì´ë¦„: document.getElementById('add-name').value, ì „í™”ë²ˆí˜¸: document.getElementById('add-tel').value, í¬ì¸íŠ¸: 0};
      const res = await callApi(data);
      alert(res.message);
      showPage('checkin');
    }
  </script>
</body>
</html>